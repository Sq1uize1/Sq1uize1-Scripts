-- Scripts/Games/BloxFruits.luau
-- Sq1uize1 | Blox Fruits module (self-contained UI)
-- This file expects to be loaded like: fetcher.load("{Repository}Games/BloxFruits.luau")(fetcher, ...)

return function(fetcher, ...)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

-- safe helper
local function safe_pcall(fn)
    local ok, res = pcall(fn)
    return ok, res
end

-- =========================
-- Settings / state
-- =========================
_G.Sq1uize1 = _G.Sq1uize1 or {}
local state = _G.Sq1uize1
state.Farm = state.Farm or false
state.Aimbot = state.Aimbot or false
state.SelectedStat = state.SelectedStat or "Melee" -- default

-- utility: find nearest hostile (model with Humanoid not belonging to player)
local function getNearestEnemy(maxDist)
    maxDist = maxDist or 200
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local hrp = char.HumanoidRootPart
    local nearest, nd = nil, maxDist
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChildWhichIsA("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            local hum = v:FindFirstChildWhichIsA("Humanoid")
            -- skip players
            local owner = Players:GetPlayerFromCharacter(v)
            if not owner and hum.Health > 0 then
                local d = (v.HumanoidRootPart.Position - hrp.Position).Magnitude
                if d < nd then
                    nd = d
                    nearest = v
                end
            end
        end
    end
    return nearest
end

-- =========================
-- Core features
-- =========================
-- Auto Farm: teleport to nearest enemy and attempt to kill (simple approach)
local farmCo
local function startFarm()
    if farmCo then return end
    state.Farm = true
    farmCo = RunService.Heartbeat:Connect(function()
        if not state.Farm then return end
        pcall(function()
            local char = LocalPlayer.Character
            if not char or not char:FindFirstChild("HumanoidRootPart") then return end
            local target = getNearestEnemy(250)
            if target and target:FindFirstChild("HumanoidRootPart") then
                -- Move near target
                local hrp = char.HumanoidRootPart
                hrp.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
                -- attempt damage (naive, game-specific logic may be required)
                local hum = target:FindFirstChildWhichIsA("Humanoid")
                if hum and hum.Health > 0 then
                    hum.Health = 0
                end
            end
        end)
        task.wait(0.2)
    end)
end

local function stopFarm()
    state.Farm = false
    if farmCo then
        farmCo:Disconnect()
        farmCo = nil
    end
end

-- Aimbot: orient character/camera toward nearest enemy (basic)
local aimConn
local function startAimbot()
    if aimConn then return end
    state.Aimbot = true
    aimConn = RunService.Heartbeat:Connect(function()
        if not state.Aimbot then return end
        pcall(function()
            local char = LocalPlayer.Character
            if not char or not char:FindFirstChild("HumanoidRootPart") then return end
            local target = getNearestEnemy(500)
            if target and target:FindFirstChild("HumanoidRootPart") then
                local myPos = char.HumanoidRootPart.Position
                local targetPos = target.HumanoidRootPart.Position
                char.HumanoidRootPart.CFrame = CFrame.new(myPos, targetPos)
            end
        end)
    end)
end

local function stopAimbot()
    state.Aimbot = false
    if aimConn then
        aimConn:Disconnect()
        aimConn = nil
    end
end

-- AutoStats: tries to call typical remote to add points (game-specific)
local function autoMaxStat(statName)
    pcall(function()
        local rem = ReplicatedStorage:FindFirstChild("Remotes") or ReplicatedStorage:FindFirstChild("Remotes", true) or ReplicatedStorage:FindFirstChild("CommF_")
        -- Common Blox Fruits remote is Remotes or Remotes.CommF_ or CommF_
        if ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("CommF_") then
            local comm = ReplicatedStorage.Remotes:FindFirstChild("CommF_")
            if comm and comm.InvokeServer then
                comm:InvokeServer("AddPoint", statName, 100) -- request 100 points
            end
        elseif ReplicatedStorage:FindFirstChild("CommF_") then
            local comm = ReplicatedStorage:FindFirstChild("CommF_")
            if comm and comm.InvokeServer then
                comm:InvokeServer("AddPoint", statName, 100)
            end
        end
    end)
end

-- =========================
-- Simple Screen GUI
-- =========================
local function createUI()
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    -- remove old
    local old = playerGui:FindFirstChild("Sq1uize1GUI")
    if old then old:Destroy() end

    local screen = Instance.new("ScreenGui")
    screen.Name = "Sq1uize1GUI"
    screen.ResetOnSpawn = false
    screen.Parent = playerGui

    local frame = Instance.new("Frame", screen)
    frame.Name = "Main"
    frame.AnchorPoint = Vector2.new(0, 0)
    frame.Position = UDim2.new(0.02, 0, 0.15, 0)
    frame.Size = UDim2.new(0, 320, 0, 220)
    frame.BackgroundTransparency = 0.15
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    frame.BorderSizePixel = 0
    frame.ZIndex = 2

    local uiCorner = Instance.new("UICorner", frame); uiCorner.CornerRadius = UDim.new(0,8)

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, -12, 0, 28)
    title.Position = UDim2.new(0,6,0,6)
    title.Text = "Sq1uize1 â€” Blox Fruits"
    title.TextColor3 = Color3.fromRGB(255,255,255)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextXAlignment = Enum.TextXAlignment.Left

    local function makeButton(text, posY, callback)
        local btn = Instance.new("TextButton", frame)
        btn.Size = UDim2.new(0, 140, 0, 32)
        btn.Position = UDim2.new(0, 10 + ((posY-1) * 150), 0, 40 + ((posY-1) * 40))
        btn.Text = text
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
        btn.BorderSizePixel = 0
        local c = Instance.new("UICorner", btn)
        c.CornerRadius = UDim.new(0,6)
        btn.MouseButton1Click:Connect(function()
            pcall(callback)
        end)
        return btn
    end

    local farmBtn = makeButton("Toggle Auto Farm", 1, function()
        if state.Farm then stopFarm() else startFarm() end
    end)

    local aimBtn = makeButton("Toggle Aimbot", 2, function()
        if state.Aimbot then stopAimbot() else startAimbot() end
    end)

    local statBtn = makeButton("Auto Max Selected Stat", 3, function()
        autoMaxStat(state.SelectedStat)
    end)

    local statLabel = Instance.new("TextLabel", frame)
    statLabel.Position = UDim2.new(0, 160, 0, 40)
    statLabel.Size = UDim2.new(0, 150, 0, 24)
    statLabel.Text = "Stat: " .. state.SelectedStat
    statLabel.TextColor3 = Color3.fromRGB(220,220,220)
    statLabel.BackgroundTransparency = 1
    statLabel.Font = Enum.Font.Gotham
    statLabel.TextSize = 13
    statLabel.TextXAlignment = Enum.TextXAlignment.Left

    local stats = {"Melee","Defense","Sword","Gun","Demon Fruit"}
    local idx = 1
    local changeStat = makeButton("Change Stat", 4, function()
        idx = idx % #stats + 1
        state.SelectedStat = stats[idx]
        statLabel.Text = "Stat: " .. state.SelectedStat
    end)

    -- Close button
    local close = Instance.new("TextButton", frame)
    close.Size = UDim2.new(0, 28, 0, 24)
    close.Position = UDim2.new(1, -36, 0, 6)
    close.Text = "X"
    close.Font = Enum.Font.GothamBold
    close.TextSize = 14
    close.TextColor3 = Color3.fromRGB(255,255,255)
    close.BackgroundTransparency = 0.25
    close.BorderSizePixel = 0
    local closeCorner = Instance.new("UICorner", close); closeCorner.CornerRadius = UDim.new(0,6)
    close.MouseButton1Click:Connect(function()
        screen.Enabled = not screen.Enabled
    end)
end

-- create UI
safe_pcall(createUI)

-- cleanup on unload
task.spawn(function()
    while true do
        if not Players:FindFirstChild(LocalPlayer.Name) then break end
        task.wait(60)
    end
    -- if player left, stop loops
    stopFarm()
    stopAimbot()
end)

end
